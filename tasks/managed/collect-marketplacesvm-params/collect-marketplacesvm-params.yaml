---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: collect-marketplacesvm-params
  labels:
    app.kubernetes.io/version: "0.2.0"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: release
spec:
  description: >-
    Tekton task that collects the secret for the cloud marketplaces from the data file
  params:
    - name: dataPath
      type: string
      description: Path to the merged data JSON file generated by collect-data task
  workspaces:
    - name: data
      description: The workspace where the data json file resides
  results:
    - name: cloudMarketplacesSecret
      type: string
      description: "The base64 encoded secret to use for various cloud marketplaces."
    - name: prePush
      type: string
      description: "Whether perform a pre-push (true) or not (false). When true it will not publish PROD."
  steps:
    - name: collect-marketplacesvm-params
      image:
        quay.io/konflux-ci/release-service-utils:6556e8a6b031c1aad4f0472703fd121a6e1cd45d
      script: |
        #!/usr/bin/env bash
        set -eux

        DATA_FILE="$(workspaces.data.path)/$(params.dataPath)"
        if [ ! -f "${DATA_FILE}" ] ; then
            echo "No valid data file was provided."
            exit 1
        fi

        if [ "$(jq '.mapping | has("cloudMarketplacesSecret")' "$DATA_FILE")" == false ] ; then
            echo "Marketplaces secret missing in data JSON file"
            exit 1
        fi

        jq -j '.mapping.cloudMarketplacesSecret' "$DATA_FILE" | tee "$(results.cloudMarketplacesSecret.path)"
        jq -j '.mapping.cloudMarketplacesPrePush // false' "$DATA_FILE" | tee > "$(results.prePush.path)"
